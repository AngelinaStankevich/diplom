{% extends 'base.html' %}
{% load budget_extras %}
{% block title %}Аналитика расходов{% endblock %}
{% block content %}
<h1>Аналитика расходов по категориям</h1>

<form method="get" class="mb-4">
    <div class="row align-items-end">
        <div class="col-md-3">
            <label for="month" class="form-label">Месяц:</label>
            <input type="month" id="month" name="month" value="{{ month }}" class="form-control">
        </div>
        <div class="col-md-auto">
            <button class="btn btn-primary" type="submit">Показать</button>
        </div>
    </div>
</form>

{% if values and values|length > 0 %}
    <!-- Сводная информация -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <h6 class="card-title">Общая сумма расходов</h6>
                    <h3 class="mb-0">{{ total_expenses|floatformat:2 }} BYN</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <h6 class="card-title">Средний расход</h6>
                    <h3 class="mb-0">{{ avg_expense|floatformat:2 }} BYN</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <h6 class="card-title">Количество категорий</h6>
                    <h3 class="mb-0">{{ categories_count }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-dark">
                <div class="card-body">
                    <h6 class="card-title">Максимальный расход</h6>
                    <h3 class="mb-0">{{ max_expense|floatformat:2 }} BYN</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Графики -->
    <div class="row">
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Распределение расходов</h5>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-secondary active" onclick="toggleChart('pie', this)">Круговая</button>
                        <button class="btn btn-outline-secondary" onclick="toggleChart('doughnut', this)">Кольцевая</button>
                    </div>
                </div>
                <div class="card-body">
                    <canvas id="pieChart" width="300" height="300"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Сравнение расходов</h5>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-secondary active" onclick="toggleBarChart('bar', this)">Столбцы</button>
                        <button class="btn btn-outline-secondary" onclick="toggleBarChart('line', this)">График</button>
                    </div>
                </div>
                <div class="card-body">
                    <canvas id="barChart" width="300" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Таблица с деталями -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="card-title mb-0">Детальная информация</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Категория</th>
                            <th>Сумма</th>
                            <th>% от общего</th>
                            <th>Визуализация</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for label, value in labels|zip_lists:values %}
                        <tr>
                            <td>{{ label }}</td>
                            <td>{{ value|floatformat:2 }} BYN</td>
                            <td>{{ value|mul:100|div:total_expenses|floatformat:1 }}%</td>
                            <td>
                                <div class="progress" style="height: 20px;">
                                    <div class="progress-bar" role="progressbar" 
                                         style="width: {{ value|mul:100|div:total_expenses }}%;"
                                         aria-valuenow="{{ value|mul:100|div:total_expenses|floatformat:1 }}"
                                         aria-valuemin="0" 
                                         aria-valuemax="100">
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    {{ labels|json_script:"labels-data" }}
    {{ values|json_script:"values-data" }}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
    const labels = JSON.parse(document.getElementById('labels-data').textContent);
    const values = JSON.parse(document.getElementById('values-data').textContent);
    const colors = [
        '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#C9CBCF',
        '#FF99CC', '#99CCFF', '#FFFF99', '#99FFCC', '#CC99FF', '#FFB366', '#E6E6E6'
    ];

    let pieChart, barChart;

    // Функция для создания круговой диаграммы
    function createPieChart(type = 'pie') {
        if (pieChart) {
            pieChart.destroy();
        }
        const ctxPie = document.getElementById('pieChart').getContext('2d');
        pieChart = new Chart(ctxPie, {
            type: type,
            data: {
                labels: labels,
                datasets: [{
                    data: values,
                    backgroundColor: colors,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { 
                        position: 'bottom',
                        display: true
                    }
                }
            }
        });
    }

    // Функция для создания столбчатой диаграммы
    function createBarChart(type = 'bar') {
        if (barChart) {
            barChart.destroy();
        }
        const ctxBar = document.getElementById('barChart').getContext('2d');
        barChart = new Chart(ctxBar, {
            type: type,
            data: {
                labels: labels,
                datasets: [{
                    label: 'Расходы',
                    data: values,
                    backgroundColor: type === 'bar' ? colors : 'rgba(54, 162, 235, 0.2)',
                    borderColor: type === 'bar' ? colors : 'rgba(54, 162, 235, 1)',
                    borderWidth: 1,
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value + ' BYN';
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    }

    // Функции переключения типов диаграмм
    function toggleChart(type, btn) {
        btn.parentElement.querySelectorAll('.btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        createPieChart(type);
    }

    function toggleBarChart(type, btn) {
        btn.parentElement.querySelectorAll('.btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        createBarChart(type);
    }

    // Инициализация диаграмм
    createPieChart();
    createBarChart();
    </script>
    <style>
    #pieChart, #barChart {
        width: 100% !important;
        height: 300px !important;
    }
    .card {
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        border-radius: 0.5rem;
        margin-bottom: 1rem;
    }
    .card-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid rgba(0,0,0,.125);
        padding: 1rem;
    }
    .card-body {
        padding: 1.25rem;
    }
    .progress {
        background-color: #e9ecef;
        border-radius: 0.25rem;
    }
    .progress-bar {
        background-color: #0d6efd;
        transition: width 0.6s ease;
    }
    .btn-group-sm > .btn {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }
    </style>
{% else %}
    <div class="alert alert-info mt-4">Нет данных для отображения диаграммы.</div>
{% endif %}
{% endblock %}